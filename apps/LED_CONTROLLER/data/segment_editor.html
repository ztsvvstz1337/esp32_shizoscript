<div class="container">
  <div class="section open">
    <h2>LED Segment Editor</h2>
    <div class="controls">
      <div id="outputs"></div>
      <button onclick="addOutput()">+ Add Output</button>
      <h3 style="color: var(--neon-dim); margin-top:1rem;">Generated JSON</h3>
      <pre id="json-output"></pre>
    </div>
  </div>
</div>

<style>
  .segment-card {
    background: var(--input-bg);
    border: 1px solid var(--neon-blue);
    border-radius: 12px;
    margin-bottom: 12px;
    box-shadow: 0 0 8px rgba(0,255,255,0.3);
  }
  .segment-header {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-bottom: 1px solid var(--neon-blue);
    gap: 0.5rem;
  }
  .drag-handle {
    cursor: grab;
    font-size: 1.2rem;
    color: var(--neon-dim);
    flex-shrink: 0;
  }
  .segment-header input[type="text"] {
    flex: 1;
    padding: 0.3rem;
    border: 1px solid var(--neon-blue);
    border-radius: 6px;
    background: var(--input-bg);
  }
  .delete-btn {
    background: crimson;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.3rem;
    cursor: pointer;
    box-shadow: 0 0 5px crimson;
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .segment-body {
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .flags {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .flags label {
    font-size: 0.9rem;
    color: var(--neon-dim);
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
</style>

<script>
let outputs = [];

function addOutput() {
  outputs.push({
    name: "Output",
    pin: 0,
    segments: []
  });
  renderOutputs();
}

function addSegment(outputIndex) {
  outputs[outputIndex].segments.push({
    name: "Segment",
    width: 10,
    count: 1,
    color: "#ffffff",
    brightness: 100,
    enabled: true,
    reverse: false,
    mirror: false
  });
  renderOutputs();
}

function deleteSegment(outputIndex, segmentIndex) {
  outputs[outputIndex].segments.splice(segmentIndex, 1);
  renderOutputs();
}

function renderOutputs() {
  const outputsDiv = document.getElementById("outputs");
  outputDiv.innerHTML = `
	  <div class="output-header" style="display:flex; gap:1rem; align-items:center; margin-bottom:0.5rem;">
		<label style="flex:1;">
		  Name:
		  <input type="text" value="${output.name}" 
			oninput="outputs[${oi}].name=this.value">
		</label>
		<label style="width:100px;">
		  Pin:
		  <input type="number" min="0" value="${output.pin}" 
			oninput="outputs[${oi}].pin=parseInt(this.value)">
		</label>
	  </div>
	`;
  outputs.forEach((output, oi) => {
    const outputDiv = document.createElement("div");
    outputDiv.className = "output";
    output.segments.forEach((seg, si) => {
      const segCard = document.createElement("div");
      segCard.className = "segment-card";
      segCard.draggable = true;
      segCard.dataset.outputIndex = oi;
      segCard.dataset.segmentIndex = si;

      segCard.innerHTML = `
        <div class="segment-header">
          <span class="drag-handle">☰</span>
          <input type="text" value="${seg.name}" oninput="outputs[${oi}].segments[${si}].name=this.value">
          <button class="delete-btn" onclick="deleteSegment(${oi},${si})">✖</button>
        </div>
        <div class="segment-body">
          <div class="flags">
            <label><input type="checkbox" ${seg.enabled ? "checked" : ""} onchange="outputs[${oi}].segments[${si}].enabled=this.checked">Enabled</label>
            <label><input type="checkbox" ${seg.reverse ? "checked" : ""} onchange="outputs[${oi}].segments[${si}].reverse=this.checked">Reverse</label>
            <label><input type="checkbox" ${seg.mirror ? "checked" : ""} onchange="outputs[${oi}].segments[${si}].mirror=this.checked">Mirror</label>
          </div>
          <label>Width: <input type="number" value="${seg.width}" min="1" oninput="outputs[${oi}].segments[${si}].width=parseInt(this.value)"></label>
          <label>Count: <input type="number" value="${seg.count}" min="1" oninput="outputs[${oi}].segments[${si}].count=parseInt(this.value)"></label>
          <label>Brightness: <input type="range" min="0" max="255" value="${seg.brightness}" oninput="outputs[${oi}].segments[${si}].brightness=parseInt(this.value)"></label>
          <label>Color: <input type="color" value="${seg.color}" oninput="outputs[${oi}].segments[${si}].color=this.value"></label>
        </div>
      `;

      const dragHandle = segCard.querySelector(".drag-handle");
      dragHandle.addEventListener("mousedown", () => {
        segCard.draggable = true;
      });
      segCard.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", JSON.stringify({ oi, si }));
      });
      segCard.addEventListener("dragover", e => e.preventDefault());
      segCard.addEventListener("drop", e => {
        e.preventDefault();
        const data = JSON.parse(e.dataTransfer.getData("text/plain"));
        if (data.oi === oi) {
          const moved = outputs[oi].segments.splice(data.si, 1)[0];
          let dropIndex = si;
          if (data.si < si) dropIndex++;
          outputs[oi].segments.splice(dropIndex, 0, moved);
          renderOutputs();
        }
      });

      outputDiv.appendChild(segCard);
    });
    const addBtn = document.createElement("button");
    addBtn.textContent = "+ Add Segment";
    addBtn.onclick = () => addSegment(oi);
    outputDiv.appendChild(addBtn);
    outputsDiv.appendChild(outputDiv);
  });

  document.getElementById("json-output").textContent = JSON.stringify(outputs, null, 2);
}
</script>
