
<div class="section open">
<h2>LED Segment Editor</h2>
<div class="controls">
  <div id="outputs"></div>
  <button onclick="addLEDOutput()">+ Add LED WS2812B Output</button>
  <button onclick="addDMXOutput('dmx')">+ Add DMX Output</button>
</div>
</div>


<style>
  .segment-card {
    background: var(--input-bg);
    border: 1px solid var(--neon-blue);
    border-radius: 12px;
    margin-bottom: 12px;
    box-shadow: 0 0 8px rgba(0,255,255,0.3);
  }
  .segment-header {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-bottom: 1px solid var(--neon-blue);
    gap: 0.5rem;
  }
  .drag-handle {
    cursor: grab;
    font-size: 1.2rem;
    color: var(--neon-dim);
    flex-shrink: 0;
  }
  .segment-header input[type="text"] {
    flex: 1;
    padding: 0.3rem;
    border: 1px solid var(--neon-blue);
    border-radius: 6px;
    background: var(--input-bg);
  }
  .delete-btn {
    background: crimson;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.3rem;
    cursor: pointer;
    box-shadow: 0 0 5px crimson;
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .segment-body {
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .flags {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .flags label {
    font-size: 0.9rem;
    color: var(--neon-dim);
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
</style>

<style>
  /* optional: prevents iOS from interpreting drag handle gestures as scroll */
  .drag-handle { touch-action: none; }
</style>

<script>
// *** Top-level outputs object ***
let outputs = {
  led_outputs: [],
  dmx_outputs: []
};

// --- DMX Fixture Types ---
const DMX_FIXTURE_TYPES = [
  { id: "rgb", name: "RGB (3-channel)" },
  { id: "rgbw", name: "RGBW (4-channel)" },
  { id: "dimmer", name: "Dimmer (1-channel)" }
];

// --- Generic Add Output from HTML Buttons ---
function addOutput(type) {
  if (type === 'led') addLEDOutput();
  if (type === 'dmx') addDMXOutput();
}

// --- Add / Delete Outputs ---
function addLEDOutput() {
  outputs.led_outputs.push({
    name: "LED Output",
    pin: 0,
    segments: []
  });
  renderOutputs();
}

function addDMXOutput() {

  if (outputs.dmx_outputs.length >= 1) {
    alert("Only one DMX is supported yet.");
    return;
  }

  outputs.dmx_outputs.push({
    name: "DMX Universe",
    txPin: 0,
    rxPin: 0,
    rtsPin: 0,
    fixtures: []
  });
  renderOutputs();
}

function deleteLEDOutput(index) {
  outputs.led_outputs.splice(index, 1);
  renderOutputs();
}

function deleteDMXOutput(index) {
  outputs.dmx_outputs.splice(index, 1);
  renderOutputs();
}

// --- Segments / Fixtures ---
function addSegment(ledIndex) {
  outputs.led_outputs[ledIndex].segments.push({
    name: "Segment",
	group: "Default",
    width: 10,
    height: 1,
    count: 1,
    color: "#000000",
    brightness: 255,
    enabled: true,
    reverse: false,
    mirror: false
  });
  renderOutputs();
}

function deleteSegment(ledIndex, segIndex) {
  outputs.led_outputs[ledIndex].segments.splice(segIndex, 1);
  renderOutputs();
}

function addFixture(dmxIndex) {
  outputs.dmx_outputs[dmxIndex].fixtures.push({
    name: "Fixture",
    fixtureType: "rgb",
    address: 1,
    count: 1,
    width: 1,
    height: 1,
    enabled: true
  });
  renderOutputs();
}

function deleteFixture(dmxIndex, fixIndex) {
  outputs.dmx_outputs[dmxIndex].fixtures.splice(fixIndex, 1);
  renderOutputs();
}

// --- Fetch initial data ---
function initOutputs() {
  fetch('/segments_get', { method: 'POST' })
    .then(res => {
      if (!res.ok) throw new Error("Failed to get segments");
      return res.json();
    })
    .then(data => {
      // Accept old array form, or the new object form
      if (Array.isArray(data)) {
        // Legacy support: treat as LED outputs only
        outputs = { led_outputs: data, dmx_outputs: [] };
      } else if (data && typeof data === 'object') {
        outputs = {
          led_outputs: data.led_outputs || [],
          dmx_outputs: data.dmx_outputs || []
        };
      } else {
        outputs = { led_outputs: [], dmx_outputs: [] };
      }
      renderOutputs(false);
    })
    .catch(err => {
      console.error("Error fetching segments from ESP:", err);
      outputs = { led_outputs: [], dmx_outputs: [] };
      renderOutputs(false);
    });
}

document.addEventListener("DOMContentLoaded", initOutputs);

// --- Send updated data to ESP ---
let sending = false;
let sendPending = false;

function sendToESP() {
  if (sending) {
    sendPending = true;
    return;
  }
  sending = true;
  fetch('/segments_update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(outputs)
  })
  .then(res => {
    if (!res.ok) throw new Error("ESP update failed: " + res.status);
    return res.text();
  })
  .then(txt => console.log("ESP responded:", txt))
  .catch(err => console.error("Error sending to ESP:", err))
  .finally(() => {
    sending = false;
    if (sendPending) {
      sendPending = false;
      sendToESP();
    }
  });
}

// --- Render Outputs ---
function renderOutputs(send = true) {
  const outputsDiv = document.getElementById("outputs");
  outputsDiv.innerHTML = "";

  // --- LED OUTPUTS ---
  outputs.led_outputs.forEach((output, oi) => {
    const outputDiv = document.createElement("div");
    outputDiv.className = "output";
    outputDiv.innerHTML = `
      <div class="output-header" style="display:flex; gap:1rem; align-items:center; margin-bottom:0.5rem;">
        <label style="flex:1;">
          Name:
          <input type="text" value="${output.name}" oninput="outputs.led_outputs[${oi}].name=this.value;sendToESP();">
        </label>
        <label style="width:100px;">Pin:
          <input type="number" min="0" value="${output.pin}" oninput="outputs.led_outputs[${oi}].pin=parseInt(this.value);sendToESP();">
        </label>
        <button class="delete-btn" onclick="deleteLEDOutput(${oi})">✖</button>
      </div>
    `;
    // segments
    output.segments.forEach((seg, si) => {
      const segCard = document.createElement("div");
      segCard.className = "segment-card";
      segCard.innerHTML = `
        <div class="segment-header">
          <span class="drag-handle">☰</span>
          <input type="text" value="${seg.name}" 
            oninput="outputs.led_outputs[${oi}].segments[${si}].name=this.value;sendToESP();">
          <button class="delete-btn" onclick="deleteSegment(${oi},${si})">✖</button>
        </div>
        <div class="segment-body">
          <label>Width: <input type="number" value="${seg.width}" min="1" 
            oninput="outputs.led_outputs[${oi}].segments[${si}].width=parseInt(this.value);sendToESP();"></label>
          <label>Height: <input type="number" value="${seg.height}" min="1" 
            oninput="outputs.led_outputs[${oi}].segments[${si}].height=parseInt(this.value);sendToESP();"></label>
          <label>Count: <input type="number" value="${seg.count}" min="1" 
            oninput="outputs.led_outputs[${oi}].segments[${si}].count=parseInt(this.value);sendToESP();"></label>
          <label>Brightness: <input type="range" min="0" max="255" value="${seg.brightness}" 
            oninput="outputs.led_outputs[${oi}].segments[${si}].brightness=parseInt(this.value);sendToESP();"></label>
          <label>Color: <input type="color" value="${seg.color}" 
            oninput="outputs.led_outputs[${oi}].segments[${si}].color=this.value;sendToESP();"></label>
		  <label>Group: <input type="text" value="${seg.group}"
		    oninput="outputs.led_outputs[${oi}].segments[${si}].group=this.value;sendToESP();"></label>
		</div>
      `;
      outputDiv.appendChild(segCard);
    });
    const addBtn = document.createElement("button");
    addBtn.textContent = "+ Add Segment";
    addBtn.onclick = () => addSegment(oi);
    outputDiv.appendChild(addBtn);
    outputsDiv.appendChild(outputDiv);
  });

  // --- DMX OUTPUTS ---
  outputs.dmx_outputs.forEach((universe, ui) => {
    const universeDiv = document.createElement("div");
    universeDiv.className = "output";
    universeDiv.innerHTML = `
      <div class="output-header" style="display:flex; gap:1rem; align-items:center; margin-bottom:0.5rem;">
        <label style="flex:1;">
          Name:
          <input type="text" value="${universe.name}" oninput="outputs.dmx_outputs[${ui}].name=this.value;sendToESP();">
        </label>
        <label style="width:80px;">TX Pin:
          <input type="number" min="0" value="${universe.txPin}" oninput="outputs.dmx_outputs[${ui}].txPin=parseInt(this.value);sendToESP();">
        </label>
        <label style="width:80px;">RX Pin:
          <input type="number" min="0" value="${universe.rxPin}" oninput="outputs.dmx_outputs[${ui}].rxPin=parseInt(this.value);sendToESP();">
        </label>
        <label style="width:80px;">RTS Pin:
          <input type="number" min="0" value="${universe.rtsPin}" oninput="outputs.dmx_outputs[${ui}].rtsPin=parseInt(this.value);sendToESP();">
        </label>
        <button class="delete-btn" onclick="deleteDMXOutput(${ui})">✖</button>
      </div>
    `;
    // fixtures
    universe.fixtures.forEach((fix, fi) => {
      const fixCard = document.createElement("div");
      fixCard.className = "segment-card";
      fixCard.innerHTML = `
        <div class="segment-header">
          <span class="drag-handle">☰</span>
          <input type="text" value="${fix.name}" 
            oninput="outputs.dmx_outputs[${ui}].fixtures[${fi}].name=this.value;sendToESP();">
          <button class="delete-btn" onclick="deleteFixture(${ui},${fi})">✖</button>
        </div>
        <div class="segment-body">
          <label>Fixture Type:
            <select onchange="outputs.dmx_outputs[${ui}].fixtures[${fi}].fixtureType=this.value;sendToESP();">
              ${DMX_FIXTURE_TYPES.map(f => 
                `<option value="${f.id}" ${fix.fixtureType===f.id?'selected':''}>${f.name}</option>`).join('')}
            </select>
          </label>
          <label>DMX Address:
            <input type="number" value="${fix.address}" min="1" max="512" 
              oninput="outputs.dmx_outputs[${ui}].fixtures[${fi}].address=parseInt(this.value);sendToESP();">
          </label>
          <label>Count:
            <input type="number" value="${fix.count}" min="1" 
              oninput="outputs.dmx_outputs[${ui}].fixtures[${fi}].count=parseInt(this.value);sendToESP();">
          </label>
          <label>Width:
            <input type="number" value="${fix.width}" min="1" 
              oninput="outputs.dmx_outputs[${ui}].fixtures[${fi}].width=parseInt(this.value);sendToESP();">
          </label>
          <label>Height:
            <input type="number" value="${fix.height}" min="1" 
              oninput="outputs.dmx_outputs[${ui}].fixtures[${fi}].height=parseInt(this.value);sendToESP();">
          </label>
          <div class="flags">
            <label><input type="checkbox" ${fix.enabled ? "checked" : ""} 
              onchange="outputs.dmx_outputs[${ui}].fixtures[${fi}].enabled=this.checked;sendToESP();">Enabled</label>
          </div>
        </div>
      `;
      universeDiv.appendChild(fixCard);
    });
    const addBtn = document.createElement("button");
    addBtn.textContent = "+ Add Fixture";
    addBtn.onclick = () => addFixture(ui);
    universeDiv.appendChild(addBtn);
    outputsDiv.appendChild(universeDiv);
  });

  if (send) sendToESP();
}
</script>
